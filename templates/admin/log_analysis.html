{% extends "base.html" %}

{% block title %}로그 분석 - 관리자{% endblock %}

{% block content %}
<div class="container mt-5">
    <!-- 헤더 -->
    <div class="row mb-4">
        <div class="col">
            <div class="d-flex justify-content-between align-items-center">
                <h2><i class="bi bi-file-earmark-text me-2"></i>로그 분석</h2>
                <div>
                    <a href="{{ url_for('admin.download_logs') }}" class="btn btn-outline-primary me-2">
                        <i class="bi bi-download me-1"></i>로그 다운로드
                    </a>
                    <button type="button" class="btn btn-outline-danger me-2" data-bs-toggle="modal" data-bs-target="#clearLogsModal">
                        <i class="bi bi-trash me-1"></i>로그 초기화
                    </button>
                    <a href="{{ url_for('admin.dashboard') }}" class="btn btn-secondary">
                        <i class="bi bi-arrow-left me-1"></i>대시보드
                    </a>
                </div>
            </div>
        </div>
    </div>

    {% if not log_file_exists %}
    <div class="alert alert-warning">
        <i class="bi bi-exclamation-triangle me-2"></i>
        로그 파일이 존재하지 않습니다. 서버가 로그를 생성하면 여기에 표시됩니다.
    </div>
    {% else %}

    <!-- 통계 카드 -->
    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="card stat-card h-100">
                <div class="card-body text-center">
                    <h3 class="stat-number">{{ stats.total }}</h3>
                    <p class="stat-label mb-0">전체 로그</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card stat-error h-100">
                <div class="card-body text-center">
                    <h3 class="stat-number">{{ stats.by_level.get('ERROR', 0) }}</h3>
                    <p class="stat-label mb-0">에러</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card stat-warning h-100">
                <div class="card-body text-center">
                    <h3 class="stat-number">{{ stats.by_level.get('WARNING', 0) }}</h3>
                    <p class="stat-label mb-0">경고</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card stat-info h-100">
                <div class="card-body text-center">
                    <h3 class="stat-number">{{ stats.by_level.get('INFO', 0) }}</h3>
                    <p class="stat-label mb-0">정보</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 필터 및 검색 -->
    <div class="card mb-4">
        <div class="card-body">
            <form method="GET" action="{{ url_for('admin.log_analysis') }}" class="row g-3">
                <div class="col-md-2">
                    <label class="form-label">로그 레벨</label>
                    <select name="level" class="form-select">
                        <option value="">전체</option>
                        <option value="ERROR" {% if level_filter == 'ERROR' %}selected{% endif %}>ERROR</option>
                        <option value="WARNING" {% if level_filter == 'WARNING' %}selected{% endif %}>WARNING</option>
                        <option value="INFO" {% if level_filter == 'INFO' %}selected{% endif %}>INFO</option>
                        <option value="DEBUG" {% if level_filter == 'DEBUG' %}selected{% endif %}>DEBUG</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">IP 주소</label>
                    <input type="text" name="ip" class="form-control" value="{{ ip_filter }}" placeholder="예: 127.0.0.1">
                </div>
                <div class="col-md-3">
                    <label class="form-label">검색어</label>
                    <input type="text" name="search" class="form-control" value="{{ search_query }}" placeholder="로그 내용 검색...">
                </div>
                <div class="col-md-2">
                    <label class="form-label">표시 개수</label>
                    <select name="limit" class="form-select">
                        <option value="100" {% if limit == 100 %}selected{% endif %}>100개</option>
                        <option value="500" {% if limit == 500 %}selected{% endif %}>500개</option>
                        <option value="1000" {% if limit == 1000 %}selected{% endif %}>1,000개</option>
                        <option value="5000" {% if limit == 5000 %}selected{% endif %}>5,000개</option>
                    </select>
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="bi bi-search me-1"></i>검색
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div class="row">
        <!-- 로그 목록 -->
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-list-ul me-2"></i>로그 목록 ({{ logs|length }}개)</h5>
                    <button class="btn btn-sm btn-outline-secondary" onclick="refreshLogs()">
                        <i class="bi bi-arrow-clockwise"></i>
                    </button>
                </div>
                <div class="card-body p-0">
                    <div class="log-container">
                        {% if logs %}
                        {% for log in logs %}
                        <div class="log-entry log-{{ log.level|lower }}">
                            <div class="log-header">
                                <span class="log-level badge bg-{{ 'danger' if log.level == 'ERROR' else 'warning' if log.level == 'WARNING' else 'info' if log.level == 'INFO' else 'secondary' }}">
                                    {{ log.level }}
                                </span>
                                {% if log.timestamp %}
                                <span class="log-timestamp">{{ log.timestamp }}</span>
                                {% endif %}
                                {% if log.logger %}
                                <span class="log-logger">{{ log.logger }}</span>
                                {% endif %}
                                {% if log.ip %}
                                <a href="{{ url_for('admin.log_analysis', ip=log.ip) }}" class="log-ip">
                                    <i class="bi bi-pc-display"></i> {{ log.ip }}
                                </a>
                                {% endif %}
                            </div>
                            <div class="log-message">{{ log.message }}</div>
                            {% if log.details %}
                            <div class="log-details">{{ log.details }}</div>
                            {% endif %}
                        </div>
                        {% endfor %}
                        {% else %}
                        <div class="text-center py-5 text-muted">
                            <i class="bi bi-inbox fs-1 mb-3 d-block"></i>
                            <p>표시할 로그가 없습니다.</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- 사이드바 - 통계 상세 -->
        <div class="col-lg-4">
            <!-- 로거별 통계 -->
            {% if stats.by_logger %}
            <div class="card mb-3">
                <div class="card-header">
                    <h6 class="mb-0"><i class="bi bi-diagram-3 me-2"></i>로거별 통계</h6>
                </div>
                <div class="card-body">
                    <ul class="list-group list-group-flush">
                        {% for logger, count in stats.by_logger.items() %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            {{ logger }}
                            <span class="badge bg-primary rounded-pill">{{ count }}</span>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
            {% endif %}

            <!-- IP별 통계 -->
            {% if stats.by_ip %}
            <div class="card mb-3">
                <div class="card-header">
                    <h6 class="mb-0"><i class="bi bi-globe me-2"></i>IP별 접속 통계 (상위 20)</h6>
                </div>
                <div class="card-body">
                    <ul class="list-group list-group-flush">
                        {% for ip, count in stats.by_ip.items() %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <a href="{{ url_for('admin.log_analysis', ip=ip) }}" class="text-decoration-none">
                                {{ ip }}
                            </a>
                            <span class="badge bg-secondary rounded-pill">{{ count }}</span>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
            {% endif %}

            <!-- 최근 에러 -->
            {% if stats.recent_errors %}
            <div class="card mb-3">
                <div class="card-header bg-danger text-white">
                    <h6 class="mb-0"><i class="bi bi-exclamation-octagon me-2"></i>최근 에러</h6>
                </div>
                <div class="card-body p-0">
                    <ul class="list-group list-group-flush">
                        {% for error in stats.recent_errors[:5] %}
                        <li class="list-group-item">
                            <small class="text-muted d-block">{{ error.timestamp or 'N/A' }}</small>
                            <span class="text-truncate d-block" title="{{ error.message }}">{{ error.message[:100] }}{% if error.message|length > 100 %}...{% endif %}</span>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
            {% endif %}

            <!-- 최근 경고 -->
            {% if stats.recent_warnings %}
            <div class="card">
                <div class="card-header bg-warning text-dark">
                    <h6 class="mb-0"><i class="bi bi-exclamation-triangle me-2"></i>최근 경고</h6>
                </div>
                <div class="card-body p-0">
                    <ul class="list-group list-group-flush">
                        {% for warning in stats.recent_warnings[:5] %}
                        <li class="list-group-item">
                            <small class="text-muted d-block">{{ warning.timestamp or 'N/A' }}</small>
                            <span class="text-truncate d-block" title="{{ warning.message }}">{{ warning.message[:100] }}{% if warning.message|length > 100 %}...{% endif %}</span>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}
</div>

<!-- 로그 초기화 확인 모달 -->
<div class="modal fade" id="clearLogsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-exclamation-triangle text-warning me-2"></i>로그 초기화 확인</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>정말 로그 파일을 초기화하시겠습니까?</p>
                <p class="text-muted small">초기화 전 자동으로 백업 파일이 생성됩니다.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                <form method="POST" action="{{ url_for('admin.clear_logs') }}" class="d-inline">
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-trash me-1"></i>초기화
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
/* ============================================
   Log Analysis Styles
   ============================================ */

.stat-card {
    background: rgba(18, 0, 36, 0.6);
    border: 1px solid rgba(200, 170, 255, 0.3);
    border-radius: 12px;
}

.stat-card.stat-error {
    border-color: rgba(220, 53, 69, 0.5);
    background: rgba(220, 53, 69, 0.1);
}

.stat-card.stat-warning {
    border-color: rgba(255, 193, 7, 0.5);
    background: rgba(255, 193, 7, 0.1);
}

.stat-card.stat-info {
    border-color: rgba(13, 202, 240, 0.5);
    background: rgba(13, 202, 240, 0.1);
}

.stat-number {
    font-size: 2.5rem;
    font-weight: 700;
    color: #E8D4FF;
    margin-bottom: 0;
}

.stat-card.stat-error .stat-number {
    color: #ff6b7a;
}

.stat-card.stat-warning .stat-number {
    color: #ffc107;
}

.stat-card.stat-info .stat-number {
    color: #0dcaf0;
}

.stat-label {
    color: rgba(255, 255, 255, 0.7);
    font-size: 0.9rem;
}

/* Log Container */
.log-container {
    max-height: 600px;
    overflow-y: auto;
}

.log-entry {
    padding: 12px 16px;
    border-bottom: 1px solid rgba(200, 170, 255, 0.15);
    transition: background 0.2s ease;
}

.log-entry:hover {
    background: rgba(200, 170, 255, 0.08);
}

.log-entry.log-error {
    border-left: 3px solid #dc3545;
    background: rgba(220, 53, 69, 0.08);
}

.log-entry.log-warning {
    border-left: 3px solid #ffc107;
    background: rgba(255, 193, 7, 0.08);
}

.log-entry.log-info {
    border-left: 3px solid #0dcaf0;
}

.log-entry.log-debug {
    border-left: 3px solid #6c757d;
    opacity: 0.8;
}

.log-header {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    align-items: center;
    margin-bottom: 6px;
}

.log-level {
    font-size: 0.7rem;
    font-weight: 600;
}

.log-timestamp {
    font-size: 0.75rem;
    color: rgba(255, 255, 255, 0.6);
    font-family: monospace;
}

.log-logger {
    font-size: 0.75rem;
    color: #E8D4FF;
    background: rgba(200, 170, 255, 0.2);
    padding: 2px 8px;
    border-radius: 4px;
}

.log-ip {
    font-size: 0.75rem;
    color: #0dcaf0;
    text-decoration: none;
}

.log-ip:hover {
    text-decoration: underline;
}

.log-message {
    font-size: 0.85rem;
    color: rgba(255, 255, 255, 0.9);
    word-break: break-word;
    font-family: monospace;
}

.log-details {
    font-size: 0.75rem;
    color: rgba(255, 255, 255, 0.6);
    margin-top: 4px;
    font-family: monospace;
}

/* Card Styles */
.card {
    background: rgba(18, 0, 36, 0.6);
    border: 1px solid rgba(200, 170, 255, 0.3);
}

.card-header {
    background: rgba(200, 170, 255, 0.1);
    border-bottom: 1px solid rgba(200, 170, 255, 0.2);
    color: #E8D4FF;
}

.list-group-item {
    background: transparent;
    border-color: rgba(200, 170, 255, 0.15);
    color: rgba(255, 255, 255, 0.85);
}

.form-control, .form-select {
    background: rgba(18, 0, 36, 0.8);
    border-color: rgba(200, 170, 255, 0.3);
    color: #fff;
}

.form-control:focus, .form-select:focus {
    background: rgba(18, 0, 36, 0.9);
    border-color: rgba(200, 170, 255, 0.6);
    color: #fff;
    box-shadow: 0 0 0 0.25rem rgba(200, 170, 255, 0.15);
}

.form-control::placeholder {
    color: rgba(255, 255, 255, 0.4);
}

.form-label {
    color: #E8D4FF;
}

/* Light Mode */
body.light-mode .stat-card {
    background: rgba(255, 255, 255, 0.9);
    border: 1px solid rgba(139, 92, 246, 0.2);
}

body.light-mode .stat-number {
    color: #5B3A8C;
}

body.light-mode .stat-card.stat-error .stat-number {
    color: #dc3545;
}

body.light-mode .stat-card.stat-warning .stat-number {
    color: #b38600;
}

body.light-mode .stat-card.stat-info .stat-number {
    color: #0a8fa5;
}

body.light-mode .stat-label {
    color: #666;
}

body.light-mode .log-container {
    background: #fff;
}

body.light-mode .log-entry {
    border-bottom-color: rgba(0, 0, 0, 0.1);
}

body.light-mode .log-entry:hover {
    background: rgba(139, 92, 246, 0.05);
}

body.light-mode .log-entry.log-error {
    background: rgba(220, 53, 69, 0.05);
}

body.light-mode .log-entry.log-warning {
    background: rgba(255, 193, 7, 0.08);
}

body.light-mode .log-timestamp {
    color: #666;
}

body.light-mode .log-logger {
    color: #5B3A8C;
    background: rgba(139, 92, 246, 0.15);
}

body.light-mode .log-message {
    color: #333;
}

body.light-mode .log-details {
    color: #666;
}

body.light-mode .card {
    background: rgba(255, 255, 255, 0.95);
    border-color: rgba(139, 92, 246, 0.2);
}

body.light-mode .card-header {
    background: rgba(139, 92, 246, 0.08);
    border-bottom-color: rgba(139, 92, 246, 0.15);
    color: #5B3A8C;
}

body.light-mode .list-group-item {
    color: #333;
    border-color: rgba(0, 0, 0, 0.1);
}

body.light-mode .form-control,
body.light-mode .form-select {
    background: #fff;
    border-color: rgba(139, 92, 246, 0.3);
    color: #333;
}

body.light-mode .form-control:focus,
body.light-mode .form-select:focus {
    background: #fff;
    border-color: rgba(139, 92, 246, 0.6);
    color: #333;
}

body.light-mode .form-label {
    color: #5B3A8C;
}

/* Modal */
body.light-mode .modal-content {
    background: #fff;
}

body.light-mode .modal-header,
body.light-mode .modal-body {
    color: #333;
}
</style>

<script>
function refreshLogs() {
    window.location.reload();
}

// 자동 새로고침 (선택사항 - 주석 해제하여 활성화)
// setInterval(function() {
//     window.location.reload();
// }, 30000); // 30초마다
</script>
{% endblock %}
