{% extends "base.html" %}

{% block title %}Î≥¥Ïïà ÎåÄÏãúÎ≥¥Îìú - StyleGrapher Admin{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">üõ°Ô∏è Î≥¥Ïïà ÎåÄÏãúÎ≥¥Îìú</h5>
                    <small class="text-muted">Ïã§ÏãúÍ∞Ñ Î≥¥Ïïà Î™®ÎãàÌÑ∞ÎßÅ Î∞è ÏúÑÌòë Î∂ÑÏÑù</small>
                </div>
                <div class="card-body">
                    <!-- Î≥¥Ïïà ÏöîÏïΩ -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="card bg-info text-white">
                                <div class="card-body text-center">
                                    <h3>{{ security_summary.total_events }}</h3>
                                    <p class="mb-0">ÏµúÍ∑º 1ÏãúÍ∞Ñ Ïù¥Î≤§Ìä∏</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-warning text-white">
                                <div class="card-body text-center">
                                    <h3>{{ security_summary.unique_ips }}</h3>
                                    <p class="mb-0">Í≥†Ïú† IP Ï£ºÏÜå</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-danger text-white">
                                <div class="card-body text-center">
                                    <h3>{{ security_summary.top_attack_types|length }}</h3>
                                    <p class="mb-0">Í≥µÍ≤© Ïú†Ìòï</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-success text-white">
                                <div class="card-body text-center">
                                    <h3>ÌôúÏÑ±</h3>
                                    <p class="mb-0">Î≥¥Ïïà ÏÉÅÌÉú</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Í≥µÍ≤© Ïú†Ìòï Î∂ÑÏÑù -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6>Ï£ºÏöî Í≥µÍ≤© Ïú†Ìòï</h6>
                                </div>
                                <div class="card-body">
                                    {% if security_summary.top_attack_types %}
                                        <div class="table-responsive">
                                            <table class="table table-sm">
                                                <thead>
                                                    <tr>
                                                        <th>Í≥µÍ≤© Ïú†Ìòï</th>
                                                        <th>ÌöüÏàò</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for attack_type, count in security_summary.top_attack_types %}
                                                    <tr>
                                                        <td>
                                                            {% if attack_type == 'BLOCKED_REQUEST' %}
                                                                <span class="badge bg-danger">Ï∞®Îã®Îêú ÏöîÏ≤≠</span>
                                                            {% elif attack_type == 'RATE_LIMIT' %}
                                                                <span class="badge bg-warning">Rate Limit</span>
                                                            {% elif attack_type == '404_ERROR' %}
                                                                <span class="badge bg-info">404 Ïò§Î•ò</span>
                                                            {% else %}
                                                                <span class="badge bg-secondary">{{ attack_type }}</span>
                                                            {% endif %}
                                                        </td>
                                                        <td><strong>{{ count }}</strong></td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                    {% else %}
                                        <p class="text-muted">ÏµúÍ∑º Í≥µÍ≤©Ïù¥ Í∞êÏßÄÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6>ÏÉÅÏúÑ Í≥µÍ≤© IP</h6>
                                </div>
                                <div class="card-body">
                                    {% if security_summary.top_ips %}
                                        <div class="table-responsive">
                                            <table class="table table-sm">
                                                <thead>
                                                    <tr>
                                                        <th>IP Ï£ºÏÜå</th>
                                                        <th>ÏöîÏ≤≠ Ïàò</th>
                                                        <th>Ïï°ÏÖò</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for ip, count in security_summary.top_ips %}
                                                    <tr>
                                                        <td><code>{{ ip }}</code></td>
                                                        <td><strong>{{ count }}</strong></td>
                                                        <td>
                                                            <button class="btn btn-sm btn-outline-danger" onclick="blockIP('{{ ip }}')">
                                                                Ï∞®Îã®
                                                            </button>
                                                        </td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                    {% else %}
                                        <p class="text-muted">ÏùòÏã¨Ïä§Îü¨Ïö¥ IPÍ∞Ä Í∞êÏßÄÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ÏµúÍ∑º Î≥¥Ïïà Ïù¥Î≤§Ìä∏ -->
                    <div class="card">
                        <div class="card-header">
                            <h6>ÏµúÍ∑º Î≥¥Ïïà Ïù¥Î≤§Ìä∏</h6>
                        </div>
                        <div class="card-body">
                            {% if security_summary.recent_events %}
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>ÏãúÍ∞Ñ</th>
                                                <th>Ïú†Ìòï</th>
                                                <th>IP</th>
                                                <th>Í≤ΩÎ°ú</th>
                                                <th>ÏÑ∏Î∂ÄÏÇ¨Ìï≠</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for event in security_summary.recent_events %}
                                            <tr>
                                                <td>{{ event.timestamp.strftime('%H:%M:%S') }}</td>
                                                <td>
                                                    {% if event.type == 'BLOCKED_REQUEST' %}
                                                        <span class="badge bg-danger">Ï∞®Îã®</span>
                                                    {% elif event.type == 'RATE_LIMIT' %}
                                                        <span class="badge bg-warning">Rate Limit</span>
                                                    {% elif event.type == '404_ERROR' %}
                                                        <span class="badge bg-info">404</span>
                                                    {% else %}
                                                        <span class="badge bg-secondary">{{ event.type }}</span>
                                                    {% endif %}
                                                </td>
                                                <td><code>{{ event.client_ip }}</code></td>
                                                <td><code>{{ event.path }}</code></td>
                                                <td class="text-truncate" style="max-width: 200px;">{{ event.details }}</td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            {% else %}
                                <p class="text-muted">ÏµúÍ∑º Î≥¥Ïïà Ïù¥Î≤§Ìä∏Í∞Ä ÏóÜÏäµÎãàÎã§.</p>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Ïï°ÏÖò Î≤ÑÌäº -->
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="btn-group" role="group">
                                <a href="{{ url_for('admin.security_report', hours=1) }}" class="btn btn-outline-primary">
                                    1ÏãúÍ∞Ñ Î¶¨Ìè¨Ìä∏ Îã§Ïö¥Î°úÎìú
                                </a>
                                <a href="{{ url_for('admin.security_report', hours=24) }}" class="btn btn-outline-primary">
                                    24ÏãúÍ∞Ñ Î¶¨Ìè¨Ìä∏ Îã§Ïö¥Î°úÎìú
                                </a>
                                <button class="btn btn-outline-success" onclick="location.reload()">
                                    ÏÉàÎ°úÍ≥†Ïπ®
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function blockIP(ip) {
    if (confirm(`IP Ï£ºÏÜå ${ip}Î•º Ï∞®Îã®ÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) {
        // Ïã§Ï†ú Íµ¨ÌòÑÏóêÏÑúÎäî AJAX Ìò∏Ï∂úÎ°ú IP Ï∞®Îã® Ï≤òÎ¶¨
        fetch('/admin/block-ip', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ip: ip})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('IPÍ∞Ä ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Ï∞®Îã®ÎêòÏóàÏäµÎãàÎã§.');
                location.reload();
            } else {
                alert('IP Ï∞®Îã®Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
            }
        });
    }
}

// ÏûêÎèô ÏÉàÎ°úÍ≥†Ïπ® (30Ï¥àÎßàÎã§)
setInterval(function() {
    location.reload();
}, 30000);
</script>
{% endblock %} 